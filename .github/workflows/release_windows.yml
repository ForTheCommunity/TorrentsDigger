name: Build & Release for Windows Platform.

on:
  push:
    tags:
      - "windows_build*"

jobs:
  build-release:
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Repository.
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: x86_64-pc-windows-msvc

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"

      - name: Get Flutter Dependencies
        run: flutter pub get

      - name: Dart Build Runner
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Build App
        run: flutter build windows --release

      - name: Extract App Version from pubspec.yaml
        id: extract_version
        run: |
          $version = (Get-Content pubspec.yaml | Where-Object { $_ -match 'version:' } | ForEach-Object { ($_.Split(' ')[1]).Split('+')[0] })
          echo "APP_VERSION=$version" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        shell: powershell

      - name: Instal Inno Setup
        uses: crazy-max/ghaction-chocolatey@v3
        with:
          args: install innosetup

      - name: Create Windows Installer
        run: iscc.exe "windows/installer.iss" /DAppVersion=${{ env.APP_VERSION }}

      - name: Generate Checksum
        shell: powershell
        run: |
          # 1. Find the installer
          $installer = Get-ChildItem -Path installers/*.exe | Select-Object -First 1

          if ($installer) {
              # 2. Calculate SHA256 Hash
              $hash = (Get-FileHash $installer.FullName -Algorithm SHA256).Hash.ToLower()
              
              # 3. Create a clean filename (e.g., app_windows_checksum.txt)
              $checksumPath = "installers/checksum_sha256.txt"
              
              # 4. Write hash - Use Set-Content to avoid BOM or extra spacing issues
              "$hash  $($installer.Name)" | Set-Content -Path $checksumPath
              
              Write-Host "Created unique checksum at: $checksumPath"
          } else {
              Write-Error "No .exe found!"
              exit 1
          }

      - name: Create Release and Upload Artifact
        uses: softprops/action-gh-release@v2
        with:
          files: |
            installers/*.exe
            installers/checksum_sha256.txt